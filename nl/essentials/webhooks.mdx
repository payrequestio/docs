---
title: 'Webhooks'
description: 'Ontvang realtime meldingen over betaalgebeurtenissen'
---

# Webhooks

Met webhooks ontvangt je applicatie realtime meldingen wanneer er gebeurtenissen plaatsvinden in je PayRequest-account. In plaats van de API continu te pollen verstuurt PayRequest HTTP POST-verzoeken naar jouw endpoint zodra er iets gebeurt.

## Hoe webhooks werken

<Steps>
  <Step title="Gebeurtenis vindt plaats">
    Er gebeurt iets in je PayRequest-account (bijv. een betaling wordt voltooid)
  </Step>
  <Step title="PayRequest stuurt verzoek">
    PayRequest verstuurt een HTTP POST-verzoek naar je webhook-endpoint
  </Step>
  <Step title="Jouw app verwerkt">
    Je applicatie ontvangt en verwerkt de webhook-payload
  </Step>
  <Step title="Retourneer 200-response">
    Je endpoint stuurt een statuscode 200 terug als ontvangstbevestiging
  </Step>
</Steps>

## Webhooks instellen

### 1. Maak een webhook-endpoint

Maak in je applicatie een endpoint om webhookmeldingen te ontvangen:

<CodeGroup>
```javascript Express.js
const express = require('express');
const app = express();

// Middleware om de ruwe body vast te leggen
app.use('/webhook', express.raw({ type: 'application/json' }));

app.post('/webhook', (req, res) => {
  const event = JSON.parse(req.body);

  // Verwerk de gebeurtenis
  console.log('Ontvangen event:', event.type);

  // Stuur 200 terug als bevestiging
  res.status(200).send('OK');
});
```

```python Flask
from flask import Flask, request, jsonify
import json

app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def handle_webhook():
    event = request.get_json()

    # Verwerk de gebeurtenis
    print(f"Ontvangen event: {event['type']}")

    # Stuur 200 terug als bevestiging
    return 'OK', 200
```

```php PHP
<?php
// webhook.php
$payload = file_get_contents('php://input');
$event = json_decode($payload, true);

// Verwerk de gebeurtenis
error_log("Ontvangen event: " . $event['type']);

// Stuur 200 terug als bevestiging
http_response_code(200);
echo 'OK';
?>
```

```ruby Rails
class WebhooksController < ApplicationController
  skip_before_action :verify_authenticity_token

  def payrequest
    event = JSON.parse(request.body.read)

    # Verwerk de gebeurtenis
    Rails.logger.info "Ontvangen event: #{event['type']}"

    # Stuur 200 terug als bevestiging
    head :ok
  end
end
```
</CodeGroup>

### 2. Registreer je webhook

Registreer je endpoint via het dashboard of de API:

<Tabs>
  <Tab title="Dashboard">
    1. Ga in het dashboard naar **Instellingen > Webhooks**
    2. Klik op **Webhook-endpoint toevoegen**
    3. Vul je endpoint-URL in (in productie verplicht HTTPS)
    4. Selecteer de events die je wilt ontvangen
    5. Klik op **Webhook aanmaken**
  </Tab>

  <Tab title="API">
    ```bash
    curl -X POST https://api.payrequest.io/v1/webhooks \
      -H "Authorization: Bearer your_api_key" \
      -H "Content-Type: application/json" \
      -d '{
        "url": "https://jouwsite.com/webhook",
        "events": ["payment.completed", "payment.failed"]
      }'
    ```
  </Tab>
</Tabs>

## Webhook-events

PayRequest verstuurt webhooks voor diverse gebeurtenissen. Dit zijn de meest gebruikte:

<AccordionGroup>
  <Accordion title="payment.created" icon="plus">
    Wordt verstuurd wanneer een nieuw betaalverzoek is aangemaakt.

    ```json
    {
      "type": "payment.created",
      "data": {
        "id": "pay_1234567890",
        "amount": 2500,
        "currency": "USD",
        "status": "pending",
        "created_at": "2024-01-15T10:30:00Z"
      }
    }
    ```
  </Accordion>

  <Accordion title="payment.completed" icon="check">
    Wordt verstuurd wanneer een betaling succesvol is afgerond.

    ```json
    {
      "type": "payment.completed",
      "data": {
        "id": "pay_1234567890",
        "amount": 2500,
        "currency": "USD",
        "status": "completed",
        "completed_at": "2024-01-15T10:35:00Z"
      }
    }
    ```
  </Accordion>

  <Accordion title="payment.failed" icon="x">
    Wordt verstuurd wanneer een betalingspoging mislukt.

    ```json
    {
      "type": "payment.failed",
      "data": {
        "id": "pay_1234567890",
        "amount": 2500,
        "currency": "USD",
        "status": "failed",
        "failure_reason": "insufficient_funds"
      }
    }
    ```
  </Accordion>

  <Accordion title="payment.cancelled" icon="ban">
    Wordt verstuurd wanneer een betaling is geannuleerd.

    ```json
    {
      "type": "payment.cancelled",
      "data": {
        "id": "pay_1234567890",
        "amount": 2500,
        "currency": "USD",
        "status": "cancelled",
        "cancelled_at": "2024-01-15T10:32:00Z"
      }
    }
    ```
  </Accordion>
</AccordionGroup>

## Veiligheid van webhooks

### Webhook-handtekeningen verifiÃ«ren

PayRequest ondertekent elke webhook met een geheim. Controleer altijd de handtekening om te verzekeren dat het verzoek echt van PayRequest komt:

<CodeGroup>
```javascript Node.js
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload, 'utf8')
    .digest('hex');

  return signature === `sha256=${expectedSignature}`;
}

app.post('/webhook', (req, res) => {
  const signature = req.headers['payrequest-signature'];
  const payload = req.body;

  if (!verifyWebhookSignature(payload, signature, webhookSecret)) {
    return res.status(401).send('Invalid signature');
  }

  // Verwerk de webhook...
  res.status(200).send('OK');
});
```

```python Python
import hmac
import hashlib

def verify_webhook_signature(payload, signature, secret):
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        payload.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()

    return signature == f"sha256={expected_signature}"

@app.route('/webhook', methods=['POST'])
def handle_webhook():
    signature = request.headers.get('payrequest-signature')
    payload = request.get_data(as_text=True)

    if not verify_webhook_signature(payload, signature, webhook_secret):
        return 'Invalid signature', 401

    # Verwerk de webhook...
    return 'OK', 200
```
</CodeGroup>

### Best practices

<Warning>
  **Controleer webhook-handtekeningen altijd** om te voorkomen dat kwaadwillende verzoeken je applicatie bereiken.
</Warning>

- **Gebruik HTTPS**: Accepteer in productie alleen webhooks via HTTPS
- **Verifieer handtekeningen**: Valideer elke webhook-handtekening
- **Idempotent verwerken**: Ga netjes om met dubbele webhooks
- **Snel antwoorden**: Stuur snel een 200 terug en verwerk zware taken asynchroon
- **Timeouts**: PayRequest stopt na 30 seconden wachten

## Webhook-events verwerken

### Verwerkingspatroon

<CodeGroup>
```javascript Node.js
app.post('/webhook', (req, res) => {
  const event = JSON.parse(req.body);

  // Bevestig direct ontvangst
  res.status(200).send('OK');

  // Verwerk het event asynchroon
  processEventAsync(event);
});

async function processEventAsync(event) {
  try {
    switch (event.type) {
      case 'payment.completed':
        await fulfillOrder(event.data);
        await sendConfirmationEmail(event.data);
        break;

      case 'payment.failed':
        await handleFailedPayment(event.data);
        break;

      default:
        console.log(`Onbekend eventtype: ${event.type}`);
    }
  } catch (error) {
    console.error('Fout bij verwerken webhook:', error);
    // Voeg eventueel toe aan een retry-queue
  }
}
```

```python Python
from celery import Celery

app = Celery('webhook_processor')

@app.route('/webhook', methods=['POST'])
def handle_webhook():
    event = request.get_json()

    # Bevestig ontvangst direct
    # Verwerk event asynchroon
    process_event_async.delay(event)

    return 'OK', 200

@app.task
def process_event_async(event):
    try:
        if event['type'] == 'payment.completed':
            fulfill_order(event['data'])
            send_confirmation_email(event['data'])
        elif event['type'] == 'payment.failed':
            handle_failed_payment(event['data'])
    except Exception as e:
        print(f"Fout bij verwerken webhook: {e}")
        # Voeg eventueel toe aan een retry-queue
```
</CodeGroup>

### Idempotentie

Verwerk dubbele webhooks probleemloos door idempotent te werken:

```javascript
const processedEvents = new Set();

app.post('/webhook', (req, res) => {
  const event = JSON.parse(req.body);
  const eventId = event.id;

  // Controleren of het event al is verwerkt
  if (processedEvents.has(eventId)) {
    return res.status(200).send('Already processed');
  }

  // Verwerk het event
  processEvent(event);

  // Markeer als verwerkt
  processedEvents.add(eventId);

  res.status(200).send('OK');
});
```

## Webhooks testen

### Lokale ontwikkeling

Gebruik tools zoals ngrok om je lokale server publiek te maken voor tests:

```bash
# Installeer ngrok
npm install -g ngrok

# Stel je lokale server bloot
ngrok http 3000

# Gebruik de gegenereerde URL in je webhook-instellingen
# https://abc123.ngrok.io/webhook
```

### Webhook-testtool

PayRequest biedt in het dashboard een webhook-testtool:

1. Ga naar **Instellingen > Webhooks**
2. Klik op **Webhook testen** naast je endpoint
3. Kies een eventtype en verstuur een testpayload
4. Bekijk de respons en los eventuele fouten op

### Voorbeeld-testevents

<AccordionGroup>
  <Accordion title="Test payment completed">
    ```json
    {
      "id": "evt_test_12345",
      "type": "payment.completed",
      "created_at": "2024-01-15T10:30:00Z",
      "data": {
        "id": "pay_test_12345",
        "amount": 2500,
        "currency": "USD",
        "status": "completed",
        "description": "Test payment",
        "metadata": {
          "order_id": "test_order_123"
        }
      }
    }
    ```
  </Accordion>

  <Accordion title="Test payment failed">
    ```json
    {
      "id": "evt_test_67890",
      "type": "payment.failed",
      "created_at": "2024-01-15T10:30:00Z",
      "data": {
        "id": "pay_test_67890",
        "amount": 1000,
        "currency": "USD",
        "status": "failed",
        "failure_reason": "card_declined",
        "failure_message": "Your card was declined."
      }
    }
    ```
  </Accordion>
</AccordionGroup>

## Probleemoplossing

### Veelvoorkomende issues

<AccordionGroup>
  <Accordion title="Webhook komt niet aan" icon="exclamation-triangle">
    **Mogelijke oorzaken:**
    - Endpoint-URL is onjuist of onbereikbaar
    - Firewall blokkeert inkomende verzoeken
    - Server retourneert geen statuscode 200

    **Oplossingen:**
    - Controleer of je endpoint bereikbaar is
    - Check firewall-instellingen
    - Zorg dat je endpoint een 200-status terugstuurt
  </Accordion>

  <Accordion title="Handtekeningverificatie faalt" icon="key">
    **Mogelijke oorzaken:**
    - Verkeerde webhook-secret
    - Middleware past de body aan
    - Onjuiste berekening van de handtekening

    **Oplossingen:**
    - Controleer het geheim in het dashboard
    - Lees de ruwe request-body uit
    - Controleer je logica voor het berekenen van de handtekening
  </Accordion>

  <Accordion title="Dubbele events" icon="copy">
    **Mogelijke oorzaken:**
    - Netwerktime-outs
    - Server stuurt geen 200-status
    - Retry-mechanisme van PayRequest

    **Oplossingen:**
    - Implementeer idempotentiecontrole
    - Stuur snel een 200-respons terug
    - Verwerk dubbele events netjes
  </Accordion>
</AccordionGroup>

### Debugtools

Volg de levering van webhooks in je dashboard:

- **Delivery Attempts**: Bekijk alle afleverpogingen
- **Response Codes**: Zie welke HTTP-statuscodes zijn teruggestuurd
- **Payload Inspector**: Bekijk de exacte payload
- **Retry Schedule**: Begrijp wanneer mislukte webhooks opnieuw worden geprobeerd

## Volgende stappen

<CardGroup cols={2}>
  <Card
    title="API-referentie"
    icon="code"
    href="/api-reference/webhooks"
  >
    Beheer webhooks via de API
  </Card>
  <Card
    title="Beveiligingsgids"
    icon="shield"
    href="/nl/essentials/security"
  >
    Beveilig je webhook-endpoints
  </Card>
  <Card
    title="Fouthandling"
    icon="triangle-exclamation"
    href="/essentials/errors"
  >
    Ga netjes om met webhookfouten
  </Card>
  <Card
    title="Testgids"
    icon="flask"
    href="/essentials/testing"
  >
    Test je webhookintegratie grondig
  </Card>
</CardGroup>
